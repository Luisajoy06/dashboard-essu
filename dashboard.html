<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESSU Marketplace</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
  <div class="nav-left">
    <span class="logo">ðŸ‘œ</span>
    <h1>ESSU MARKETPLACE</h1>
  </div>

  <div class="search-box">
    <input type="text" placeholder="Search products...">
  </div>

  <div class="nav-right">
    <button class="sell-btn">ï¼‹ Sell Item</button>
    <span class="icon"></span>
    <span class="icon">ðŸ’²</span>
    <button onclick="openProfilePanel()">ðŸ‘¤</button>
    <button onclick="openMiniCart()" style="position:relative">ðŸ›’ <span id="cartBadge" class="badge"></span></button>
  </div>
</header>

<!-- MAIN -->
<main class="container">

  <div class="title-row">
    <h2>Discover Items</h2>
    <button class="filter-btn">âš™ Filters</button>
  </div>

  <!-- CATEGORIES -->
  <div class="categories">
    <button class="cat active">All</button>
    <button class="cat">Electronics</button>
    <button class="cat">Books</button>
    <button class="cat">Clothing</button>
    <button class="cat">Furniture</button>
    <button class="cat">Sports</button>
    <button class="cat">Food</button>
    <button class="cat">Other</button>
  </div>

  <!-- PRODUCTS GRID (populated by app.js) -->
  <div class="grid" id="itemsGrid"></div>

</main>

<!-- MINI CART PANEL -->
<div id="miniCart" class="mini-cart">
  <div class="mini-cart-content">
    <button class="mini-close" onclick="closeMiniCart()">Ã—</button>
    <h4>Your Cart</h4>
    <div id="miniCartList" style="margin-top:8px;max-height:420px;overflow:auto"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="muted">Total</div>
      <div id="miniCartTotal" style="font-weight:800;color:var(--accent)"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="closeMiniCart()" style="flex:1;background:#f3f3f3;border:none;padding:10px;border-radius:8px">Continue Shopping</button>
      <button onclick="placeOrderFromMini()" style="flex:1;background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px">Checkout</button>
    </div>
  </div>
</div>

<!-- CHECKOUT MODAL (inline stepper) -->
<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeCheckoutModal()">Ã—</button>
    <h3>Checkout</h3>

    <div id="step-login" class="hidden">
      <p class="muted">Please log in or sign up to place orders.</p>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button onclick="location.href='login.html'" style="padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff">Login</button>
        <button onclick="location.href='signup.html'" style="padding:8px 12px;border-radius:8px;border:1px solid #eee;background:#fff">Sign up</button>
      </div>
    </div>

    <div id="step-payment" class="hidden">
      <p class="muted">Step 1 â€” Choose payment method</p>
      <div style="margin:12px 0">
        <label><input type="radio" name="pmethod" value="Cash on Delivery"> Cash on Delivery</label><br>
        <label><input type="radio" name="pmethod" value="GCash"> GCash</label><br>
        <label><input type="radio" name="pmethod" value="PayMaya"> PayMaya</label>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button onclick="closeCheckoutModal()" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Cancel</button>
        <button onclick="toAddressStep()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Continue</button>
      </div>
    </div>

    <div id="step-address" class="hidden">
      <p class="muted">Step 2 â€” Delivery address</p>
      <textarea id="addressInput" placeholder="Enter your delivery address" style="min-height:90px;padding:10px;border-radius:8px;border:1px solid #eee;width:100%"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button onclick="document.getElementById('step-address').classList.add('hidden');document.getElementById('step-payment').classList.remove('hidden')" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Back</button>
        <button onclick="toReviewStep()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Continue</button>
      </div>
    </div>

    <div id="step-review" class="hidden">
      <p class="muted">Review & Confirm</p>
      <div id="checkoutItems" style="max-height:220px;overflow:auto;margin-bottom:10px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="muted">Total</div>
        <div id="checkoutTotal" style="font-weight:800;color:var(--accent)"></div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="document.getElementById('step-review').classList.add('hidden');document.getElementById('step-address').classList.remove('hidden')" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Back</button>
        <button onclick="confirmOrderFromModal()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Confirm Order</button>
      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<!-- In-dashboard Profile Panel -->
<div id="profilePanel" class="profile-panel">
  <div class="profile-panel-content">
    <button class="panel-close" onclick="closeProfilePanel()">Ã—</button>
    <section class="profile-card card">
      <div class="avatar-wrap">
        <img id="avatarImgPanel" src="" alt="avatar">
        <div id="avatarInitialsPanel" class="avatar-initials"></div>
      </div>
      <div class="profile-info">
        <h3 id="profileNamePanel">Guest</h3>
        <div class="muted" id="profileEmailPanel">-</div>
        <div style="margin-top:12px">
          <label class="btn btn-sm" for="avatarInputPanel">Change Photo</label>
          <input id="avatarInputPanel" type="file" accept="image/*" style="display:none">
          <button class="btn btn-sm" onclick="closeProfilePanel();">Back to Shop</button>
          <button class="btn btn-sm signout-btn" onclick="logout()">Sign Out</button>
        </div>
      </div>
    </section>

    <section class="orders-section">
      <h2>My Orders</h2>
      <div id="ordersListPanel" class="orders-list"></div>
    </section>
  </div>
</div>

<style>
.profile-panel{position:fixed;right:0;top:0;bottom:0;width:420px;background:var(--card);color:#111;box-shadow:-18px 0 50px rgba(0,0,0,0.12);transform:translateX(100%);transition:transform .2s;z-index:120;padding:20px;overflow:auto}
.profile-panel.open{transform:translateX(0)}
.profile-panel-content{max-width:380px;margin:0 auto}
.panel-close{position:absolute;left:8px;top:8px;border:none;background:transparent;font-size:22px;cursor:pointer}
.profile-panel .profile-card{display:flex;gap:14px;align-items:center;padding:12px;margin-bottom:12px}
.profile-panel .avatar-wrap{width:88px;height:88px;border-radius:12px;overflow:hidden;background:#f0f0f0;display:flex;align-items:center;justify-content:center}
.profile-panel .avatar-wrap img{width:100%;height:100%;object-fit:cover;display:none}
.profile-panel .avatar-initials{font-size:26px;font-weight:700;color:#fff;background:linear-gradient(135deg,#44c06b,#1ea160);width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.profile-panel .orders-section h2{margin-top:6px}
.profile-panel .muted{color:#6b7280}
</style>

<script>
function openProfilePanel(){
  document.getElementById('profilePanel').classList.add('open');
  showProfileAndOrdersPanel();
}
function closeProfilePanel(){ document.getElementById('profilePanel').classList.remove('open'); }

function showProfileAndOrdersPanel(){
  const buyer = localStorage.getItem('buyer');
  const users = JSON.parse(localStorage.getItem('users')||'[]');
  const orders = JSON.parse(localStorage.getItem('orders')||'[]');
  const email = buyer || '';
  const user = users.find(u=>u.email===email) || {};

  const nameEl = document.getElementById('profileNamePanel');
  const emailEl = document.getElementById('profileEmailPanel');
  nameEl.textContent = user.name || 'Guest';
  emailEl.textContent = user.email || '-';

  const avatarKey = 'avatar_' + (user.email||'');
  const avatarData = localStorage.getItem(avatarKey);
  const avatarImg = document.getElementById('avatarImgPanel');
  const avatarInit = document.getElementById('avatarInitialsPanel');
  if(avatarData){ avatarImg.src = avatarData; avatarImg.style.display='block'; avatarInit.style.display='none'; }
  else { avatarImg.style.display='none'; avatarInit.style.display='flex'; avatarInit.textContent = (user.name||'G').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase(); }

  const wrap = document.getElementById('ordersListPanel');
  if(!buyer){ wrap.innerHTML = '<p class="muted">Please login to see your orders.</p>'; return; }
  const my = orders.filter(o=> o.buyer === buyer);
  if(!my.length){ wrap.innerHTML = '<p class="muted">No orders yet.</p>'; return; }
  wrap.innerHTML = '';
  my.slice().reverse().forEach(o=>{
    const oc = document.createElement('div');
    oc.className = 'order-card';
    const itemsHtml = (o.items||[]).map(i=>`<div class="order-item"><img src="${i.img||'https://via.placeholder.com/48'}"><div><div style="font-weight:700">${i.name}</div><div class="muted">â‚±${i.price} &times; ${i.qty||1}</div></div></div>`).join('');
    oc.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Order ${o.id}</strong><div class="muted" style="font-size:13px">${new Date(o.createdAt).toLocaleString()}</div></div><div style="font-weight:800;color:var(--accent)">â‚±${o.total}</div></div><div class="order-items">${itemsHtml}</div><div style="margin-top:8px;color:#555">Payment: ${o.payment} â€¢ Address: ${o.address}</div>`;
    wrap.appendChild(oc);
  });
}

document.getElementById('avatarInputPanel').addEventListener('change', async function(e){
  const f = e.target.files[0];
  const buyer = localStorage.getItem('buyer')||'';
  if(!f || !buyer) return alert('Please login first.');
  const data = await new Promise(res=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(f); });
  localStorage.setItem('avatar_'+buyer, data);
  showProfileAndOrdersPanel();
});
</script>
</body>
</html>
